# Copilot Instructions for VS Code Counter Extension

## Project Overview
This is a VS Code extension called "Code Counter" that provides visual line counting with customizable emoji indicators and comprehensive project reporting. The extension follows the "127-line rule" philosophy for optimal code organization.

## Recent Major Features (v1.0.2+)

### Comprehensive Export System
- **Multiple Export Formats**: JSON, CSV, XML, and Export All functionality
- **Unified Export Interface**: Dropdown UI in both WebView and standalone reports
- **Data Consistency**: Simplified export format (metadata + files only, no calculated summaries)
- **Timestamp Integration**: All exports include `generatedAt` metadata
- **Browser Downloads**: Standalone reports use native browser download APIs
- **VS Code Integration**: WebView exports use VS Code file system APIs

### Debug System Hardening
- **Automatic Disable**: Debug logging automatically disabled on extension startup
- **Crash Protection**: Comprehensive error handling in debug operations
- **Production Safety**: Default to 'none' backend for production deployments
- **User Control**: WebView interface for debug configuration
- **Memory Management**: Efficient logging with minimal performance impact

### UI/UX Improvements
- **Column Movement**: Smooth drag-and-drop with grouped header preservation
- **Export Dropdowns**: Professional dropdown interface matching VS Code design
- **Event Handling**: Guard systems prevent double registration and conflicts
- **Theme Integration**: Consistent styling with VS Code theme variables
- **Responsive Design**: Mobile-friendly layouts and touch interactions

## Core Architecture
- **Language**: TypeScript with strict type checking
- **Framework**: VS Code Extension API 1.80.0+
- **Testing**: Mocha with Chai assertions
- **Build**: TypeScript compiler with ESLint
- **UI**: WebView API for modal interfaces

## Key Components

### Services Layer (`src/services/`)
- `LineCounterService`: Core line counting with language detection
- `LineCountCacheService`: Performance caching with modification time validation
- `lineThresholdService`: Emoji threshold classification and formatting
- `HtmlGenerator`: Interactive HTML report generation with standalone export
- `XmlGenerator`: XML data export for external tools
- `JsonGeneratorService`: JSON export with simplified data structure (metadata + files only)
- `CsvGeneratorService`: CSV export with generatedAt timestamps
- `ExportAllService`: Unified export service for all formats (JSON, CSV, XML)
- `WebViewReportService`: WebView management with comprehensive export functionality
- `DebugService`: Centralized logging with configurable backends and auto-disable on startup

### Providers Layer (`src/providers/`)
- `FileExplorerDecorationProvider`: File explorer emoji badges with real-time updates
- `EditorTabDecorationProvider`: Editor tab decorations
- `FileWatcherProvider`: File system monitoring and change detection

### WebView Interface (`src/extension.ts`)
- Professional emoji picker with 1800+ searchable emojis
- Search engine with relevance scoring and fuzzy matching
- Modal interface with keyboard navigation and tooltips
- **Export functionality**: Comprehensive export dropdown with JSON, CSV, XML, and Export All options
- **Automatic debug disable**: Extension automatically disables debug logging on startup for production safety

## Configuration Schema
```typescript
interface CodeCounterConfig {
  emojis: {
    normal: string;    // Low line count (default: ðŸŸ¢)
    warning: string;   // Medium line count (default: ðŸŸ¡)
    danger: string;    // High line count (default: ðŸ”´)
  };
  lineThresholds: {
    midThreshold: number;  // Medium threshold (default: 300)
    highThreshold: number;     // High threshold (default: 1000)
  };
  excludePatterns: string[]; // Glob patterns for exclusions
}
```

## Development Patterns

### Service Pattern
All business logic is encapsulated in services with clear interfaces:
```typescript
export class SomeService {
  constructor(private context: vscode.ExtensionContext) {}
  
  public async someMethod(): Promise<SomeResult> {
    // Implementation with proper error handling
  }
}
```

### Provider Pattern
VS Code integrations use the provider pattern:
```typescript
export class SomeProvider implements vscode.SomeProviderInterface {
  provideDecoration(uri: vscode.Uri): vscode.ProviderResult<vscode.Decoration> {
    // Implementation
  }
}
```

### Caching Strategy
Use `LineCountCacheService` for performance-critical operations:
```typescript
const cached = await this.cacheService.getOrCalculate(filePath, () => {
  return this.expensiveOperation(filePath);
});
```

## Code Standards

### TypeScript
- Strict type checking enabled
- Explicit return types for public methods
- Proper error handling with try-catch blocks
- Use `async/await` instead of Promises chains

### VS Code API Usage
- Always dispose of disposables in `context.subscriptions`
- Use `vscode.workspace.getConfiguration()` for settings
- Handle `undefined` returns from VS Code APIs gracefully
- Register providers through extension context

### Performance Requirements
- File operations must use caching when possible
- Avoid synchronous file I/O in main thread
- Debounce user input (200ms for search)
- Use efficient glob pattern matching

### Debug Logging Standards
- **NO direct console.log usage** - Use DebugService instead
- **Always use appropriate log levels**: `error`, `warning`, `info`, `verbose`
- **Initialize debug service**: `const debug = DebugService.getInstance();`
- **User-controlled logging**: Webview dropdown controls backend (None/Console) and verbosity
- **Production-ready**: Default to 'none' backend for production builds
- **Auto-disable on startup**: Extension automatically disables debug logging when activated for production safety
- **Crash protection**: Debug service includes safeguards against logging-related crashes

```typescript
// Import and initialize debug service
import { DebugService } from './services/debugService';
const debug = DebugService.getInstance();

// Use appropriate log levels
debug.error('Critical issue occurred:', error);        // System errors, exceptions
debug.warning('Potential problem detected:', issue);   // Non-critical issues
debug.info('Operation completed successfully');        // General application flow
debug.verbose('Detailed debugging info:', data);       // Development debugging

// Configure service (typically done via webview)
debug.configure('console', 'info'); // Backend: none|console, Level: error|warning|info|verbose
```

## Testing Approach

### Unit Tests
Focus on service logic and utilities:
```typescript
describe('SomeService', () => {
  it('should handle normal case', () => {
    // Test implementation
  });
  
  it('should handle error cases gracefully', () => {
    // Error scenario testing
  });
});
```

### Integration Tests
Test VS Code API integration:
```typescript
describe('Extension Integration', () => {
  it('should register all commands', () => {
    // Verify command registration
  });
});
```

## WebView Implementation

### Emoji Database Structure
```typescript
const emojiDatabase = {
  'ðŸ˜€': { 
    name: 'grinning face', 
    aliases: ['grinning', 'happy', 'smile'], 
    category: 'smileys' 
  }
  // Include comprehensive metadata for search functionality
};
```

### Search Implementation
- Use relevance scoring (exact matches > partial matches)
- Debounce input with 200ms delay
- Support keyboard navigation (Enter, Escape)
- Provide helpful no-results messages

## Common Patterns

### Configuration Access
```typescript
function getCurrentConfiguration() {
  const config = vscode.workspace.getConfiguration('codeCounter');
  const emojiConfig = vscode.workspace.getConfiguration('codeCounter.emojis');
  
  return {
    badges: {
      low: emojiConfig.get('normal', 'ðŸŸ¢'),
      medium: emojiConfig.get('warning', 'ðŸŸ¡'),
      high: emojiConfig.get('danger', 'ðŸ”´')
    },
    thresholds: {
      mid: config.get('lineThresholds.midThreshold', 300),
      high: config.get('lineThresholds.highThreshold', 1000)
    }
  };
}
```

### File Badge Updates
```typescript
// Always refresh badge decorations after configuration changes
const decorationProvider = new FileExplorerDecorationProvider();
vscode.window.onDidChangeActiveTextEditor(() => {
  decorationProvider.refresh();
});
```

### Error Handling
```typescript
try {
  const result = await riskyOperation();
  return result;
} catch (error) {
  console.error('Operation failed:', error);
  vscode.window.showErrorMessage(`Failed to perform operation: ${error.message}`);
  return defaultValue;
}
```

## File Organization Rules

### Services (`src/services/`)
- Each service handles one primary concern
- Services should be stateless when possible
- Use dependency injection through constructor

### Providers (`src/providers/`)
- Implement VS Code provider interfaces
- Handle VS Code lifecycle events
- Manage disposables properly

### Utilities (`src/utils/`)
- Pure functions with no side effects
- Comprehensive error handling
- Well-documented with JSDoc

## Performance Considerations

### Caching Strategy
- Cache file line counts with modification time validation
- Invalidate cache on file save events
- Use Map for O(1) cache lookups

### File Operations
- Use `vscode.workspace.fs` for file operations
- Batch file operations when possible
- Respect VS Code's file watcher limitations

### Memory Management
- Dispose of event listeners and providers
- Clear caches periodically
- Avoid memory leaks in WebView content

## UI/UX Guidelines

### Visual Integration
- Use VS Code theme colors for consistency
- Respect user's color preferences
- Provide hover tooltips for context

### Emoji Picker Design
- Modal overlay with click-outside-to-close
- Search-first approach with category fallback
- Keyboard accessibility (Tab, Enter, Escape)
- Visual feedback for selections

### Error Messages
- User-friendly error messages
- Actionable suggestions when possible
- Consistent with VS Code's message style

## Release Process

### Version Management
- Follow semantic versioning (MAJOR.MINOR.PATCH)
- Update CHANGELOG.md with all changes
- Ensure version consistency across files

### Quality Gates
- All tests must pass (16/16 minimum)
- TypeScript compilation with zero errors
- ESLint warnings addressed or documented
- Manual testing in extension development host
- Test using `npm run test` to ensure all tests pass

### Documentation Updates
- Update README.md for user-facing changes
- Update API documentation for breaking changes
- Maintain comprehensive CHANGELOG.md

## ðŸš€ Release Checklist

### Pre-Release Phase (Complete ALL items before proceeding)

#### ðŸ“‹ Code Quality Validation
- [ ] **Test Suite Status**: All tests passing (minimum 16/16)
  ```bash
  npm test
  # Verify: "âœ“ 16 passing" or higher
  ```
- [ ] **TypeScript Compilation**: Zero errors, warnings reviewed
  ```bash
  npm run compile
  # Verify: No compilation errors
  ```
- [ ] **ESLint Status**: All warnings addressed or documented
  ```bash
  npm run lint
  # Review and resolve critical warnings
  ```
- [ ] **Code Coverage**: Verify coverage meets minimum standards (85%+)

#### âš¡ Performance & Functionality Validation
- [ ] **Extension Development Host Testing**
  ```bash
  code . --extensionDevelopmentPath=.
  # Test all major functionality
  ```
- [ ] **Emoji Picker Functionality**
  - [ ] Modal opens correctly with `Ctrl+Shift+P` â†’ "Customize Emoji Indicators"
  - [ ] Search functionality works (try "smile", "heart", "circle")
  - [ ] Category tabs switch properly
  - [ ] Emoji selection updates configuration
  - [ ] Search debouncing works (200ms delay)
  - [ ] Keyboard navigation (Enter, Escape, Tab)
- [ ] **File Badge Updates**
  - [ ] Create/modify files and save (`Ctrl+S`)
  - [ ] Verify emoji badges update immediately in file explorer
  - [ ] Test with different line counts (< midThreshold, midThreshold-highThreshold, > highThreshold)
  - [ ] Verify hover tooltips show correct line counts
- [ ] **Glob Pattern Exclusions**
  - [ ] Add custom exclusion pattern in settings
  - [ ] Verify excluded files don't show badges
  - [ ] Test pattern removal functionality
- [ ] **Configuration Persistence**
  - [ ] Change emoji settings and restart VS Code
  - [ ] Verify settings persist across sessions
- [ ] **Performance Benchmarks**
  - [ ] Cache hit rate > 95% for repeated operations
  - [ ] File badge updates complete in < 100ms
  - [ ] Search response time < 200ms
  - [ ] Memory usage stable during extended use

#### ðŸ“ Documentation & Versioning
- [ ] **Version Consistency Check**
  - [ ] `package.json` version updated
  - [ ] Semantic versioning applied correctly:
    - `PATCH` (0.7.1): Bug fixes only
    - `MINOR` (0.8.0): New features, backward compatible
    - `MAJOR` (1.0.0): Breaking changes
- [ ] **CHANGELOG.md Updates**
  - [ ] New version section added at top
  - [ ] All changes categorized (Added/Changed/Fixed/Removed)
  - [ ] Technical details included for developers
  - [ ] User-facing changes highlighted
  - [ ] Release date set to current date
- [ ] **Release Notes Markdown Generation**
  - [ ] Generate comprehensive markdown for GitHub release notes
  - [ ] Include major features, bug fixes, and technical improvements
  - [ ] Add "How to Use New Features" section for user guidance
  - [ ] Format with proper headings, emojis, and professional structure
  - [ ] Prepare copy-ready text for marketplace and GitHub distributions
- [ ] **README.md Review**
  - [ ] Verify & update version in README.md if mentioned
  - [ ] Feature list reflects current functionality
  - [ ] Screenshots updated if UI changes made
  - [ ] Installation instructions current
  - [ ] Usage examples accurate
- [ ] **API Documentation**
  - [ ] Breaking changes documented
  - [ ] New public APIs documented
  - [ ] TypeScript interfaces updated

#### ðŸ”§ Build & Package Validation
- [ ] **Clean Build Process**
  ```bash
  rm -rf out/ node_modules/
  npm install
  npm run compile
  ```
- [ ] **Package Creation**
  ```bash
  npm run package
  # Verify .vsix file created successfully
  ```
- [ ] **Package Size Check**
  - [ ] .vsix file size reasonable (< 5MB typically)
  - [ ] No unnecessary files included in package
- [ ] **Cross-Platform Compatibility** (if available)
  - [ ] Windows 10/11 testing completed
  - [ ] macOS testing completed (if accessible)
  - [ ] Linux testing completed (if accessible)

### Release Execution Phase

#### ðŸ“¦ Version Update
- [ ] **Update Package Version**
  ```bash
  # Update version in package.json
  npm version patch  # or minor/major as appropriate
  # This automatically updates package.json version
  ```
- [ ] **Version Consistency Verification**
  - [ ] Verify `package.json` version updated correctly
  - [ ] Ensure semantic versioning applied correctly:
    - `PATCH` (0.7.1): Bug fixes only
    - `MINOR` (0.8.0): New features, backward compatible
    - `MAJOR` (1.0.0): Breaking changes

#### ðŸ“ Documentation Updates
- [ ] **CHANGELOG.md Updates**
  - [ ] Add new version section at top with updated version number
  - [ ] All changes categorized (Added/Changed/Fixed/Removed)
  - [ ] Technical details included for developers
  - [ ] User-facing changes highlighted
  - [ ] Release date set to current date
- [ ] **Release Notes Preparation**
  - [ ] Generate comprehensive markdown for GitHub release notes
  - [ ] Include major features, bug fixes, and technical improvements
  - [ ] Add "How to Use New Features" section for user guidance
  - [ ] Format with proper headings, emojis, and professional structure
- [ ] **README.md Review** (if needed)
  - [ ] Feature list reflects current functionality
  - [ ] Screenshots updated if UI changes made
  - [ ] Installation instructions current

#### ðŸ·ï¸ Git Repository Management
- [ ] **Final Commit & Tag**
  ```bash
  git add .
  git commit -m "Release v0.7.0: Add emoji search functionality"
  git tag v0.7.0
  git push origin main --tags
  ```
- [ ] **Branch Status**
  - [ ] All changes merged to main branch
  - [ ] Working directory clean (no uncommitted changes)
  - [ ] Remote repository synchronized

#### ðŸ“¦ Distribution Preparation
- [ ] **VS Code Marketplace Package**
  ```bash
  vsce package
  # Creates vscode-code-counter-X.Y.Z.vsix
  ```
- [ ] **Package Testing**
  ```bash
  code --install-extension vscode-code-counter-X.Y.Z.vsix
  # Test installation from package
  ```
- [ ] **Uninstall Previous Version**
  - [ ] Remove old version before testing new package
  - [ ] Verify clean installation process

#### ðŸŒ Marketplace Deployment
- [ ] **VS Code Marketplace Upload**
  - [ ] Login to Visual Studio Marketplace
  - [ ] Upload new .vsix file
  - [ ] Verify marketplace listing updated
  - [ ] Test installation from marketplace
- [ ] **GitHub Release Creation**
  - [ ] Create release on GitHub with tag
  - [ ] Upload .vsix file as release asset
  - [ ] Copy CHANGELOG content to release notes
  - [ ] Mark as latest release

### Post-Release Phase

#### ðŸ“Š Release Validation
- [ ] **Installation Testing**
  ```bash
  code --install-extension DelightfulGames.vscode-code-counter
  # Test fresh installation from marketplace
  ```
- [ ] **Functionality Verification**
  - [ ] All commands available in Command Palette
  - [ ] Extension activates without errors
  - [ ] Basic functionality works as expected
- [ ] **Rollback Preparation**
  - [ ] Previous version .vsix file available if needed
  - [ ] Rollback procedure documented

#### ðŸ“ˆ Monitoring & Communication
- [ ] **Performance Monitoring**
  - [ ] Monitor extension activation time
  - [ ] Check for error reports in first 24 hours
  - [ ] Validate marketplace download metrics
- [ ] **User Communication**
  - [ ] Update project documentation sites
  - [ ] Announce in relevant development communities
  - [ ] Monitor user feedback and bug reports
- [ ] **Issue Tracking Setup**
  - [ ] GitHub Issues ready for bug reports
  - [ ] Response plan for critical issues
  - [ ] Hotfix process documented if needed

#### ðŸ”„ Next Iteration Planning
- [ ] **Post-Release Review**
  - [ ] Document lessons learned from release process
  - [ ] Identify process improvements for next release
  - [ ] Update release checklist if needed
- [ ] **Future Planning**
  - [ ] Plan next milestone features
  - [ ] Update project roadmap
  - [ ] Schedule next release timeframe

### Emergency Hotfix Process

If critical issues are discovered post-release:

#### ðŸš¨ Critical Issue Response (Complete within 4 hours)
- [ ] **Issue Assessment**
  - [ ] Severity: Extension won't activate / Data loss / Security vulnerability
  - [ ] Impact: Number of affected users
  - [ ] Urgency: Immediate fix required
- [ ] **Hotfix Development**
  ```bash
  git checkout -b hotfix/critical-fix-v0.7.1
  # Implement minimal fix with tests
  npm test
  npm run package
  ```
- [ ] **Accelerated Release**
  - [ ] Skip non-critical checklist items
  - [ ] Focus on fix validation and core functionality
  - [ ] Immediate marketplace deployment
  - [ ] Communication to affected users

### Release Frequency Guidelines
- **Patch Releases**: As needed for critical bugs (within days)
- **Minor Releases**: Monthly for new features (planned schedule)
- **Major Releases**: Quarterly for significant changes (planned milestones)

### Quality Standards
- **Zero-Defect Policy**: No known critical bugs in releases
- **Performance Standards**: All benchmarks must pass
- **User Experience**: All user-facing features thoroughly tested
- **Documentation Currency**: All docs reflect actual functionality

## Debugging Tips

### Extension Development
```bash
# Open extension development host
code . --extensionDevelopmentPath=.

# Or use F5 for debug mode with breakpoints
```

### WebView Debugging
- Right-click in WebView â†’ "Inspect Element"
- Use console.log for debugging WebView JavaScript (client-side only)
- Use DebugService for extension logging (server-side)
- Configure debug output in webview: Debug Service dropdown â†’ "Developer Tools Console"
- Check VS Code Developer Console for extension logs (Help â†’ Toggle Developer Tools)

### Common Issues & Solutions
- Extension not activating: Check `activationEvents` in package.json
- Badges not updating: Verify file save listeners and cache invalidation
- Search not working: Check emoji database loading
- Performance issues: Profile cache hit rates and debug service impact
- **Export dropdown not working**: Verify guard variables prevent double initialization
- **Column movement issues**: Check updateGroupHeaderStructure() for DOM manipulation
- **Debug crashes**: Ensure DebugService auto-disable is functioning
- **Missing embedded data**: Verify {{DATA_FILES}} and {{DATA_JSON}} placeholders in report.html

## Security Considerations

### WebView Security
- Use Content Security Policy (CSP)
- Sanitize user input in search
- Avoid eval() and innerHTML with user data

### File Operations
- Validate file paths before operations
- Respect workspace trust boundaries
- Handle permission errors gracefully

## Integration Points

### VS Code APIs
- `vscode.window.createWebviewPanel` for modals
- `vscode.window.registerFileDecorationProvider` for badges
- `vscode.workspace.onDidSaveTextDocument` for updates
- `vscode.commands.registerCommand` for commands

### Configuration System
- `contributes.configuration` in package.json
- `vscode.workspace.getConfiguration()` for reading
- `configuration.update()` for writing
- Configuration change events for reactivity

## Standalone Report Architecture

### Report Generation Pipeline
Standalone HTML reports are generated through a multi-stage build process that combines separate source files into a single, self-contained HTML file:

#### 1. Source File Structure
- **CSS Files**: Styling components in `templates/` directory
  - `report.css`: Main report styling
  - `webview-report.css`: WebView-specific styles
  - Component-specific CSS files

- **JavaScript Files**: Functionality modules loaded in specific order
  - `tabulator-manager-common.js`: Core Tabulator utilities and smooth column movement
  - `tabulator-manager-standalone.js`: Standalone table functionality
  - `filter-manager.js`: Advanced filtering capabilities
  - `data-manager.js`: Data processing and population with summary statistics
  - `ui-handlers-standalone.js`: Event handlers, interactions, and export dropdown functionality

- **HTML Template**: `templates/report.html` with placeholders
  - `{{INJECTED_CSS}}`: CSS injection point
  - `{{JS_PLACEHOLDER}}`: JavaScript injection point
  - `{{DATA_FILES}}`: Embedded file data
  - `{{DATA_JSON}}`: Embedded metadata

#### 2. Build Process (`HtmlGenerator.ts`)
1. **CSS Minification**: All CSS files are minified and injected into `{{INJECTED_CSS}}`
2. **JavaScript Embedding**: JS files are loaded in dependency order and embedded at `{{JS_PLACEHOLDER}}`
3. **Data Embedding**: Report data is serialized and embedded as `{{DATA_FILES}}` and `{{DATA_JSON}}`
4. **Template Replacement**: All placeholders are replaced with actual content
5. **Output**: Single standalone HTML file with zero external dependencies

#### 3. Runtime Behavior
- **Self-Contained**: No external HTTP requests or file dependencies
- **Client-Side Processing**: All data manipulation happens in browser
- **Export Functionality**: JSON/CSV/XML exports work via browser download APIs with dropdown interface
- **Theme Support**: CSS variables enable light/dark theme switching
- **Responsive Design**: Mobile-friendly layout with touch interactions
- **Column Movement**: Smooth drag-and-drop column reordering with grouped header preservation
- **Guard Systems**: Prevents double event listener registration and UI handler conflicts

#### 4. Key Differences from WebView
- **Data Source**: Embedded data vs. VS Code message passing
- **Export Methods**: Browser downloads vs. VS Code file system APIs
- **Event Handling**: Direct DOM events vs. WebView postMessage
- **Styling**: Embedded CSS vs. separate CSS files
- **JavaScript Scope**: Global browser scope vs. WebView sandbox

This architecture ensures standalone reports are completely portable and functional without any VS Code dependencies while maintaining feature parity with the WebView interface.

## Current Development State (v1.0.2)

### Recently Completed Features
- âœ… **Export System**: Complete JSON/CSV/XML export functionality with dropdown UI
- âœ… **Debug Hardening**: Auto-disable on startup, crash protection, production safety
- âœ… **UI Polish**: Column movement, export dropdowns, theme integration
- âœ… **Data Consistency**: Simplified export formats, timestamp integration
- âœ… **Guard Systems**: Prevent double event registration and UI conflicts

### Active Development Areas
- ðŸ”„ **Debug Proofing**: Comprehensive debugging safety measures discussion needed
- ðŸ”„ **Performance Optimization**: Memory usage monitoring and limits
- ðŸ”„ **Error Recovery**: Enhanced error recovery mechanisms
- ðŸ”„ **User Experience**: Protection during debug scenarios

### Quality Standards Met
- âœ… **Test Coverage**: 16/16 tests passing
- âœ… **TypeScript**: Zero compilation errors
- âœ… **Performance**: Cache hit rates >95%, <100ms badge updates
- âœ… **Production Ready**: Debug auto-disable, error handling, memory management

### Known Technical Debt
- Data embedding placeholders need verification in report.html
- Column movement performance could be optimized for large datasets
- Export dropdown initialization guard systems may need refinement
- Debug service memory usage monitoring could be enhanced

This extension prioritizes user experience, performance, and seamless VS Code integration while providing powerful line counting and visualization capabilities.